<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    @Styles.Render("~/Content/css")
  
    @Scripts.Render("~/bundles/modernizr")
     
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script>
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @Html.ActionLink("Application name", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li>@Html.ActionLink("Home", "Index", "Home")</li>
                    <li>@Html.ActionLink("About", "About", "Home")</li>
                    <li>@Html.ActionLink("Contact", "Contact", "Home")</li>
                </ul>
                @Html.Partial("_LoginPartial")
            </div>
        </div>
    </div>
    <div class="container body-content">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - My ASP.NET Application</p>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
   
    @RenderSection("scripts", required: false)

</body>
</html>


<script>
    var currentRow1 = "";
    var r="";
    $(document).ready(function () {
        $("#CompanyListTable").dataTable();
       
        function myFunction() {
            document.getElementById('CurrentDate').value = Date();
        }

        LoadProduct();

        $("#add").click(function () {

            currentRow1 = $(this).closest("tr");

            //if ($("#SelectVAT").val() != "" )
            //{
            //    $("#AddVAt").append('<input type="text" name="txt" />').addClass($("#SelectVAT").val());
            //}


            var isAllValid = true;
            if ($("#SelectProductQutation").val() == "0") {
                isAllValid = false;
                alert("Please select Item");
            }

            if (isAllValid) {
                debugger;
                var $newRow = $("#mainrow").clone().removeAttr('id');
                $('.product', $newRow).val($("#SelectProductQutation").val());
                $('.VAT', $newRow).val($("#SelectVAT").val());

                //Replace add button with remove button
                $("#add", $newRow).addClass('remove').val('Remove').removeClass('btn-success').addClass('btn-danger');

                //Remove id attribute from new clone row

                $("#SelectProductQutation,#Quantity,#Rate,#FTotal,#SelectVAT", $newRow).removeAttr('id');
               
                $('span.error', $newRow).remove();
                
                $('#orderdetailsitems').append($newRow);

                $('#SelectProductQutation').val('0');
                $('#Quantity').val('');
                $('#Rate').val('');
                $('#FTotal').val('');

                if ($('#orderItemError').text != '') {
                    $('#orderItemError').text('');
                }

                calucteVatFunction();
                
            }

            //else
            //{

            //}

            //if ($('#txtLevel').val().trim() == "") {
            //    $('#txtLevel').css('border-color', 'Red');
            //    isValid = false;
            //}
            //else {
            //    $('#txtLevel').css('border-color', 'lightgrey');
            //}

           
            });

      //  });


        function calucteVatFunction() {

            if ($('#orderdetailsitems tr').length == 0) {
                $('#btwo').text('0.00');
                 $('#BTW6').text('0.00');
                 $('#BTW21').text('0.00');
            }
            else {

                var sum = 0;
                var vatValue = currentRow1.find('#SelectVAT option:selected').val();
                if (vatValue == 0) {
                    $('#btwo').text('0.00');
                }

                if (vatValue == 6) {
                    var sum6 = 0;
                    var total6 = 0;
                    $('#orderdetailsitems tr').each(function () {
                        $('#BTW6').text();
                        debugger;
                        r = $(this).closest('tr');
                        var value = r.find('.VAT  option:selected').val();
                        if (r.find('.VAT  option:selected').val() == 6) {
                            total6 = r.find('td:eq(3)').find('input').val();
                            if (!isNaN(total6) && total6.length != 0) {
                                sum6 += parseInt(total6);
                            }
                            var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                            var totalr = Math.round(totalvat6, 2);
                            $('#BTW6').text(totalvat6.toFixed(2));
                        }
                        else {
                            $('#BTW6').text('0.00');
                        }
                    })
                }
                if (vatValue == 21) {
                    var sum21 = 0;
                    var total21 = 0;
                    $('#orderdetailsitems tr').each(function () {
                        $('#BTW21').text();
                        var r = $(this).closest('tr');
                        var value = r.find('.VAT  option:selected').val();
                        if (r.find('.VAT  option:selected').val() == 21) {
                            total21 = r.find('td:eq(3)').find('input').val();
                            if (!isNaN(total21) && total21.length != 0) {
                                sum21 += parseInt(total21);
                            }
                            var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                            var totalr = Math.round(totalvat21, 2);
                            $('#BTW21').text(totalr);
                        }
                        else {
                            $('#BTW21').text('0.00');
                        }

                    })

                }
            }
        }

        $('#orderdetailsitems').on('click', '.remove', function () {
            debugger;
            var currentRow = $(this).closest('tr');
            var vat = currentRow.find('.VAT  option:selected').val();
            var Total = currentRow.find('.FTotal').val();
            if (vat == 6) {
                var totalvat6 = parseInt(Total / 100) * 6 + (Total - Total);
               
                var BTW6 = $('#BTW6').text();
                $('#BTW6').text();
                $('#BTW6').text(parseInt(BTW6-totalvat6));
     
            }
            if (vat == 21) {
                var currentRow = $(this).closest('tr');
                var vat21 = currentRow.find('.VAT  option:selected').val();
                var Total21 = currentRow.find('.FTotal').val();
                if (vat == 21) {
                    var totalvat21 = parseFloat(Total21 / 100) * 21 + (Total21 - Total21);

                    var BTW21 = $('#BTW21').text();
                    $('#BTW21').text();
                    $('#BTW21').text(parseFloat(BTW21 - totalvat21));

                }
            }
            $(this).parents('tr').remove();
                
           
            //calucteVatFunction();


        });


        $("#Submit").click(function () {

            var isAllValid = true;
            $('#orderItemError').text('');

            var list = [];
            var errorItemCount = 0;
            $('#orderdetailsitems tbody tr').each(function (index, ele) {

                if ($('#SelectProductQutation', this).val() == '0' ||
                    (parseInt($('.quantity', this).val()) || 0) == 0 ||
                    $('.rate', this).val() == "" ||
                    isNaN($('.rate', this).val())
                    ) {
                    errorItemCount++;
                    $(this).addClass('error');
                }
                else {
                    var orderItem = {
                        ItemId: $('select.product', this).val(),
                        Quantity: parseInt($('.quantity', this).val()),
                        Rate: parseFloat($('.rate', this).val()),
                        TotalAmount: parseFloat($('.FTotal', this).val()),
                        Vat: parseFloat($('.VAT', this).val())
                    }
                    list.push(orderItem);
                }
            });

            if (errorItemCount > 0) {
                $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
                isAllValid = false;
            }

            if (list.length == 0) {

                $("#orderItemError").text("At least one order item required.");
                isAllValid = false;
            }


            if (isAllValid) {
                $(this).val("please wait...");
                var empObj = {

                    Qutation_ID: $('#Qutation_ID').val(),
                    RefNumber: $('#RefNumber').val(),
                    QutationDate: $('#QutationDate').val(),
                    DueDate: $('#DueDate').val(),
                    SubTotal: $('#SubTotal').val(),
                    DiscountAmount: $('#DiscountAmount').val(),

                    Vat: $('#Vat').val(),
                    Total: $('#Total').val(),
                    CustomerNote: $('#CustomerNote').val(),
                    QutationDetailslist: list

                };
                $.ajax({
                    url: "/MVCQutation/Save",
                    data: JSON.stringify(empObj),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        if (result != 0) {
                            alert('Successfully saved');
                            list = [];
                            $('#Qutation_ID,#RefNumber,#SubTotal,#DiscountAmount,#Vat,#TotalAmount,#CustomerNote').val('');
                            $('#orderdetailsitems').empty();
                            $("#Submit").val('Save');
                        }

                    },
                    error: function (errormessage) {
                        alert(errormessage.responseText);
                    }

                });

                //console.log(data)



                //$.ajax({
                //    url: "/MVCQutation/Save",
                //    traditional: true,
                //    type: "POST",
                //    contentType: false, // Not to set any content header
                //    processData: false, //
                //    data: data,
                //    success: function (status)
                //    {
                //        if (status != 0)
                //        {
                //            alert('Successfully saved');
                //            list = [];
                //            $('#Qutation_ID,#RefNumber,#SubTotal,#DiscountAmount,#Vat,#TotalAmount,#CustomerNote').val('');
                //            $('#orderdetailsitems').empty();
                //            $("#Submit").val('Save');
                //        }
                //        else
                //        {
                //            alert('Error');
                //        }
                //        $('#Submit').text('Save');
                //    },
                //    error: function(error)
                //    {
                //        console.log(error);
                //        $('#Submit').text('Save');
                //    }


                //});

            }

        });
    });

    $(function () {
        $(".datepicker").datepicker({
            dateFormat: "dd-mm-yy",
            changeMonth: true,
            changeYear: true,
            yearRange: "-10:+10",
            //buttonText: "Select"
            //showOn: 'both',
            //buttonText: 'Calendar'

        });
    });




    </script>


@*<script>
    $(function(){
        $('#addMore').on('click', function() {
            var data = $("#maintableQutation tr:eq(1)").clone(true).appendTo("#maintableQutation");
                  data.find("input").val('');
         });
         $(document).on('click', '.remove', function() {
             var trIndex = $(this).closest("tr").index();
                if(trIndex>1) {
                 $(this).closest("tr").remove();
               } else {
                 alert("Sorry!! Can't remove first row!");
               }
          });
    });
    </script>*@



<script>
    function LoadProduct() {
        $("#SelectProductQutation").find("option").remove();
        $("#SelectProductQutation").prepend("<option value=0>" + 'Select Item' + "</option>");

        $.ajax({
            url: "/MVCProduct/GetProduct",
            type: "Get",
            async: false,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {

                $.each(data, function (key, item) {

                    $('#SelectProductQutation').append($('<option></option>').val(item.ProductId).html(item.ProductName));

                });

            },
            Error: function (errormessage) {
                alert(errormessage);
            }

        });
    }


</script>


<script>

    $('#Rate').keyup(function () {
        currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = currentRow.find("td:eq(1)").find('input').val(); // get current row 1st TD value
        var Price = $(this).val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;    
        var vatValue = currentRow1.find('#SelectVAT option:selected').val();
        if (vatValue == 0) {
            $('#btwo').text('0.00');
        }
        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
                r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseInt(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                    
                    $('#BTW6').text(totalvat6.toFixed(2));
                }             
            })
        }


        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
                r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseInt(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21').text(totalvat21.toFixed(2));
                }

            })

          

        }

    })

    $(document).on('keyup', '#orderdetailsitems .rate', function () {
        debugger;
       var currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = currentRow.find("td:eq(1)").find('input').val(); // get current row 1st TD value
        var Price = $(this).val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;
        var vatValue = currentRow1.find('.VAT  option:selected').val();
        if (vatValue == 0) {
            $('#btwo').text('0.00');
        }
        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
                r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseInt(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                   
                    $('#BTW6').text(totalvat6.toFixed(2));
                }
            })
        }


        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
                r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseInt(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21').text(totalvat21.toFixed(2));
                }

            })



        }
    });







    var vatValue=0;
    $(document).on('keyup', '#orderdetailsitems .quantity ', function () {
        debugger;
       
        var currentRow = $(this).closest("tr");
        var quantity = currentRow.find("td:eq(1)").find('input').val(); // get current row 1st TD value
        var Price = $(this).val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;
        vatValue = currentRow.find('.VAT  option:selected').val();
        if (vatValue == 0) {
            $('#btwo').text('0.00');
        }
        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
                var r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 6) {
                    total6 = r.find('td:eq(2)').find('input').val();
                    var quantit = r.find('td:eq(1)').find('input').val();

                    totalvat6 = parseFloat(quantit * total6);
                    //if (!isNaN(total21) && total21.length != 0) {
                    //    sum21 += parseInt(total21);
                    //}
                    var totalvat6 = parseFloat(totalvat6 / 100 * 6 + totalvat6 - totalvat6);
                    $('#BTW6').text(totalvat6.toFixed(2));
                }

            })



        }



        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitems tr').each(function () {
                debugger;
               var r = $(this).closest('tr');
                var value = r.find('.VAT  option:selected').val();
                if (r.find('.VAT  option:selected').val() == 21) {
                    total21 = r.find('td:eq(2)').find('input').val();
                    var quantit = r.find('td:eq(1)').find('input').val();

                    totalvat21 = parseFloat(quantit * total21);
                    //if (!isNaN(total21) && total21.length != 0) {
                    //    sum21 += parseInt(total21);
                    //}
                    var totalvat21 = parseFloat(totalvat21 / 100 * 21 + totalvat21 - totalvat21);
                    $('#BTW21').text(totalvat21.toFixed(2));
                }

            })



        }
    });







    $('#Quantity').keyup(function () {
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
    })

   

   
</script>



